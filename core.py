import config
import datetime
import random
import pymysql


#–î–æ–±–∞–≤–∏—Ç–∏ –∞–≥–µ–Ω—Ç–∞
def add_agent(agent_id):
    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"INSERT INTO agents (`agent_id`) VALUES ('{agent_id}')")
    con.commit()

    cur.close()
    con.close()


#–î–æ–±–∞–≤–∏—Ç–∏ —Ñ–∞–π–ª
def add_file(req_id, file_id, file_name, type):
    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"INSERT INTO files (`req_id`, `file_id`, `file_name`, `type`) VALUES ('{req_id}', '{file_id}', '{file_name}', '{type}')")
    con.commit()

    cur.close()
    con.close()


#–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å
def new_req(user_id, request):
    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    #–î–æ–±–∞–≤–∏—Ç–∏ –∑–∞–ø–∏—Å –≤ –ë–î
    cur.execute(f"INSERT INTO requests (`user_id`, `req_status`) VALUES ('{user_id}', 'waiting')") 

    #–û—Ç—Ä–∏–º–∞—Ç–∏ –∞–π–¥—ñ –¥–æ–±–∞–≤–ª–µ–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É
    req_id = cur.lastrowid

    dt = datetime.datetime.now()
    date_now = dt.strftime('%d.%m.%Y %H:%M:%S')

    #–î–æ–±–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∑–∞–ø–∏—Å—É
    cur.execute(f"INSERT INTO messages (`req_id`, `message`, `user_status`, `date`) VALUES ('{req_id}', '{request}', 'user', '{date_now}')")

    con.commit()

    cur.close()
    con.close()

    return req_id


#–î–æ–±–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è 
def add_message(req_id, message, user_status):
    if user_status == 'user':
        req_status = 'waiting'
    elif user_status == 'agent':
        req_status = 'answered'

    dt = datetime.datetime.now()
    date_now = dt.strftime('%d.%m.%Y %H:%M:%S')

    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    #–î–æ–±–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–ª–º–µ–Ω–Ω–Ø –¥–ª—è –∑–∞–ø–∏—Å—É 
    cur.execute(f"INSERT INTO messages (`req_id`, `message`, `user_status`, `date`) VALUES ('{req_id}', '{message}', '{user_status}', '{date_now}')")
    
    #–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å—É 
    cur.execute(f"UPDATE requests SET `req_status` = '{req_status}' WHERE `req_id` = '{req_id}'")
    
    con.commit()

    cur.close()
    con.close()


#–î–æ–±–∞–≤–∏—Ç–∏ –ø–∞—Ä–æ–ª—ñ
def add_passwords(passwords):
    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    for password in passwords:
        cur.execute(f"INSERT INTO passwords (`password`) VALUES ('{password}')")
        
    con.commit()

    cur.close()
    con.close()


#–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏  —Å—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–∞
def check_agent_status(user_id):
    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"SELECT * FROM agents WHERE `agent_id` = '{user_id}'")
    agent = cur.fetchone()

    cur.close()
    con.close()

    if agent == None:
        return False
    else:
        return True


#–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å –ø–∞—Ä–æ–ª—è
def valid_password(password):
    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"SELECT * FROM passwords WHERE `password` = '{password}'")
    password = cur.fetchone()

    cur.close()
    con.close()

    if password == None:
        return False
    else:
        return True


#–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ñ–∞–π–ª, —è–∫—â–æ —Ç–∞–∫ - –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –π–æ–≥–æ
def get_file(message):
    """
    –ê—Ç—Ä–∏–±—É—Ç file_name –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ —Ç–∏–ø–∞—Ö —Ñ–∞–π–ª–æ–≤ - document –∏ video.
    –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç –∏ –Ω–µ –≤–∏–¥–µ–æ - –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥–∞—Ç—å –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (date_now)
    """

    types = ['document', 'video', 'audio', 'voice']
    dt = datetime.datetime.now()
    date_now = dt.strftime('%d.%m.%Y %H:%M:%S')

    #–°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ñ–æ—Ç–æ 
    try:
        return {'file_id': message.json['photo'][-1]['file_id'], 'file_name': date_now, 'type': 'photo', 'text': str(message.caption)}

    #–Ø–∫—â–æ –Ω—ñ - –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –¥–æ–∫—É–º–µ–Ω—Ç, –≤—ñ–¥–µ–æ, –∞—É–¥—ñ–æ, –≥–æ–ª–æ—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è 
    except:
        for type in types:
            try:
                if type == 'document' or type == 'video':
                    file_name = message.json[type]['file_name']
                else:
                    file_name = date_now

                return {'file_id': message.json[type]['file_id'], 'file_name': file_name, 'type': type, 'text': str(message.caption)}
            except:
                pass
    
        return None


#–û—Ç—Ä–∏–º–∞—Ç–∏ —ñ–∫–æ–Ω–∫—É —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø–∏—Ç—É 
def get_icon_from_status(req_status, user_status):
    if req_status == 'confirm':
        return '‚úÖ'

    elif req_status == 'waiting':
        if user_status == 'user':
            return '‚è≥'
        elif user_status == 'agent':
            return '‚ùóÔ∏è'

    elif req_status == 'answered':
        if user_status == 'user':
            return '‚ùóÔ∏è'
        elif user_status == 'agent':
            return '‚è≥'


#–û—Ç—Ä–∏–º–∞—Ç–∏ —Ç–µ–∫—Å—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑ —Ñ–∞–π–ª–æ–º 
def get_file_text(file_name, type):
    if type == 'photo':
        return f'üì∑ | –§–æ—Ç–æ {file_name}'
    elif type == 'document':
        return f'üìÑ | –î–æ–∫—É–º–µ–Ω—Ç {file_name}'
    elif type == 'video':
        return f'üé• | –í–∏–¥–µ–æ {file_name}'
    elif type == 'audio':
        return f'üéµ | –ê—É–¥–∏–æ {file_name}'
    elif type == 'voice':
        return f'üéß | –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ {file_name}'
            

#–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø–∞—Ä–æ–ª—ñ 
def generate_passwords(number, lenght):
    chars = 'abcdefghijklnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890'

    passsords = []
    for _ in range(number):
        password = ''
        for _ in range(lenght):
            password += random.choice(chars)

        passsords.append(password)

    return passsords


#–û—Ç—Ä–∏–º–∞—Ç–∏ User ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —Å—Ç–≤–æ—Ä–∏–≤—à–æ–≥–æ –∑–∞–ø–∏—Ç 
def get_user_id_of_req(req_id):
    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"SELECT `user_id` FROM requests WHERE `req_id` = '{req_id}'")
    user_id = cur.fetchone()[0]

    cur.close()
    con.close()

    return user_id


#–û—Ç—Ä–∏–º–∞—Ç–∏ file_id —ñ–∑ id –∑–∞–ø–∏—Å—É –≤ –ë–î
def get_file_id(id):
    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"SELECT `file_id` FROM files WHERE `id` = '{id}'")
    file_id = cur.fetchone()[0]

    cur.close()
    con.close()

    return file_id


#–û—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å—É
def get_req_status(req_id):
    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"SELECT `req_status` FROM requests WHERE `req_id` = '{req_id}'")
    req_status = cur.fetchone()[0]

    cur.close()
    con.close()

    return req_status


#–í–∏–¥–∞–ª–∏—Ç–∏ –ø–∞—Ä–æ–ª—å
def delete_password(password):
    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"DELETE FROM {config.MySQL[3]}.passwords WHERE `password` = '{password}'")
    con.commit()

    cur.close()
    con.close()


#–í–∏–¥–∞–ª–∏—Ç–∏ –∞–≥–µ–Ω—Ç–∞
def delete_agent(agent_id):
    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"DELETE FROM {config.MySQL[3]}.agents WHERE `agent_id` = '{agent_id}'")
    con.commit()

    cur.close()
    con.close()


#–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –∑–∞–ø–∏—Å 
def confirm_req(req_id):
    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"UPDATE requests SET `req_status` = 'confirm' WHERE `req_id` = '{req_id}'")
    con.commit()

    cur.close()
    con.close()


#–û—Ç—Ä–∏–º–∞—Ç–∏ –ø–∞—Ä–æ–ª—ñ –∑ –ª—ñ–º—ñ—Ç–æ–º
def get_passwords(number):
    limit = (int(number) * 10) - 10

    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"SELECT `password` FROM passwords LIMIT {limit}, 10")
    passwords = cur.fetchall()

    cur.close()
    con.close()

    return passwords


#–û—Ç—Ä–∏–º–∞—Ç–∏ –∞–≥–µ–Ω—Ç—ñ–≤ –∑ –ª—ñ–º—ñ—Ç–æ–º
def get_agents(number):
    limit = (int(number) * 10) - 10

    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"SELECT `agent_id` FROM agents LIMIT {limit}, 10")
    agents = cur.fetchall()

    cur.close()
    con.close()

    return agents


#–û—Ç—Ä–∏–º–∞—Ç–∏ –º–æ—ó –∑–∞–ø–∏—Ç–∏ –∑ –ª—ñ–º—ñ—Ç–æ–º 
def my_reqs(number, user_id):
    limit = (int(number) * 10) - 10

    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"SELECT `req_id`, `req_status` FROM requests WHERE `user_id` = '{user_id}' ORDER BY `req_id` DESC LIMIT {limit}, 10")
    reqs = cur.fetchall()

    cur.close()
    con.close()

    return reqs


#–û—Ç—Ä–∏–º–∞—Ç–∏ –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ç—É—Å—É –∑ –ª—ñ–º—ñ—Ç–∞–º–∏
def get_reqs(number, callback):
    limit = (int(number) * 10) - 10
    req_status = callback.replace('_reqs', '')

    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"SELECT `req_id`, `req_status` FROM requests WHERE `req_status` = '{req_status}' ORDER BY `req_id` DESC LIMIT {limit}, 10")
    reqs = cur.fetchall()

    cur.close()
    con.close()

    return reqs


#–û—Ç—Ä–∏–º–∞—Ç–∏ —Ñ–∞–π–ª–∏ –ø–æ –∑–∞–ø–∏—Ç—É –∑ –ª—ñ–º—ñ—Ç–æ–º 
def get_files(number, req_id):
    limit = (int(number) * 10) - 10

    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"SELECT `id`, `file_name`, `type` FROM files WHERE `req_id` = '{req_id}' ORDER BY `id` DESC LIMIT {limit}, 10")
    files = cur.fetchall()

    cur.close()
    con.close()

    return files


#–û—Ç—Ä–∏–º–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –∑–∞–ø—Ä–æ—Å–∞ 
def get_request_data(req_id, callback):
    if 'my_reqs' in callback:
        get_dialog_user_status = 'user'
    else:
        get_dialog_user_status = 'agent'

    con = pymysql.connect(host=config.MySQL[0], user=config.MySQL[1], passwd=config.MySQL[2], db=config.MySQL[3])
    cur = con.cursor()

    cur.execute(f"SELECT `message`, `user_status`, `date` FROM messages WHERE `req_id` = '{req_id}'")
    messages = cur.fetchall()

    cur.close()
    con.close()

    data = []
    text = ''
    i = 1

    for message in messages:
        message_value = message[0]
        user_status = message[1]
        date = message[2] 

        if user_status == 'user':
            if get_dialog_user_status == 'user':
                text_status = 'üë§ –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'
            else:
                text_status = 'üë§ –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'
        elif user_status == 'agent':
            text_status = 'üßë‚Äçüíª –ê–≥–µ–Ω—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏'

        #–ë–µ–∫–∞–ø –¥–ª—è —Ç–µ–∫—Å—Ç—É
        backup_text = text
        text += f'{text_status}\n{date}\n{message_value}\n\n'

        #–Ø–∫—â–æ —Ä–æ–∑–º—ñ—Ä —Ç–µ–∫—Å—Ç—É –ø–µ—Ä–µ–≤–∏—â—É—î –¥–æ–ø—É—Å—Ç–∏–º—ñ –≤ –¢–µ–ª–µ–≥—Ä–∞–º, —Ç–æ –¥–æ–±–∞–≤–∏—Ç–∏ –ø–µ—Ä—à—É —á–∞—Å—Ç–∏–Ω—É —Ç–µ–∫—Å—Ç—É —ñ –ø–æ—á–∞—Ç–∏ –¥—Ä—É–≥—É —á–∞—Å—Ç–∏–Ω—É.
        if len(text) >= 4096:
            data.append(backup_text)
            text = f'{text_status}\n{date}\n{message_value}\n\n'

        #–Ø–∫—â–æ –∑–∞—Ä–∞–∑ –æ—Å—Ç–∞–Ω–Ω—è —ñ—Ç–µ—Ä–∞—Ü—ñ—è, —â–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ —á–∞—Å—Ç–∏–Ω–∞ —Ç–µ–∫—Å—Ç—É –ø–µ—Ä–µ–≤–∏—â—É—î –¥–æ–ø—É—Å—Ç–∏–º–∏–π —Ä–æ–∑–º—ñ—Ä (4096 —Å–∏–º–≤–æ–ª—ñ–≤). –Ø–∫—â–æ –≤–∏—â–µ - –¥–æ–¥–∞–π—Ç–µ —á–∞—Å—Ç–∏–Ω—É —ñ –Ω–∞–¥—Ä—É–∫—É–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—É. –Ø–∫—â–æ –Ω–µ–º–∞—î - –ø—Ä–æ—Å—Ç–æ –¥–æ–¥–∞–π—Ç–µ –æ—Å—Ç–∞–Ω–Ω—é —á–∞—Å—Ç–∏–Ω—É —Å–ø–∏—Å–∫—É.
        if len(messages) == i:
            if len(text) >= 4096:
                data.append(backup_text)
                text = f'{text_status}\n{date}\n{message_value}\n\n'
            
            data.append(text)   

        i += 1

    return data